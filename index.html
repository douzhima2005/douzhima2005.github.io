<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>COC7 æˆ˜æ–—æ§åˆ¶å° v3.0 (Rational Grid & Archive)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* =====================================================
           CSS Design System: Rational Grid & Archive
           ç¦æ­¢åœ†è§’ã€é˜´å½±ã€æ¸å˜ - ç›´è§’æ¡£æ¡ˆç¾å­¦
           ===================================================== */
        :root {
            --color-player: #2563eb;
            --color-enemy: #dc2626;
            --color-border: #e5e7eb;
            --color-border-strong: #000;
            --color-bg-primary: #fff;
            --color-bg-secondary: #f9fafb;
            --color-text-primary: #000;
            --color-text-secondary: #6b7280;
            --faction-strip-width: 4px;
        }

        * { 
            box-sizing: border-box; 
            /* å…¨å±€ç§»é™¤åœ†è§’ */
            border-radius: 0 !important;
        }
        
        html, body { 
            height: 100vh;
            height: 100dvh;
            width: 100vw;
            margin: 0; 
            padding: 0;
            overflow: hidden; 
            position: fixed;
            overscroll-behavior: none;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }

        #root {
            height: 100%;
            width: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .main-layout {
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        header {
            flex: 0 0 56px;
        }

        main {
            flex: 1;
            overflow: hidden;
            position: relative;
            height: calc(100% - 56px);
            display: flex;
            flex-direction: column;
            min-height: 0; 
        }

        /* æ¡Œé¢ç«¯ä¸‰æ å¸ƒå±€ */
        .combat-grid {
            display: grid;
            grid-template-columns: 280px 1fr 300px;
            height: 100%;
            overflow: hidden;
        }

        .panel-scroll {
            height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }

        .panel-left {
            background-color: var(--color-bg-secondary);
            border-right: 1px solid var(--color-border);
        }

        .panel-right {
            background-color: var(--color-bg-primary);
            border-left: 1px solid var(--color-border);
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }
        
        .log-scroll-area {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        .panel-center {
            position: relative;
            background-color: #f3f4f6;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .target-bar {
            flex-shrink: 0;
            background: rgba(255, 255, 255, 0.95);
            border-bottom: 1px solid var(--color-border);
            z-index: 20;
        }

        .action-area {
            flex: 1;
            position: relative;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 0;
        }

        /* ä¸­å¤®å¡ç‰‡ - æ— åœ†è§’æ— é˜´å½± */
        .centered-card {
            width: 90%;
            max-width: 440px;
            max-height: 90%;
            overflow-y: auto;
            background: var(--color-bg-primary);
            border: 1px solid var(--color-border);
            z-index: 10;
            margin: auto;
        }

        /* è®¾ç½®é¡µé¢å¸ƒå±€ */
        .setup-grid {
            display: flex;
            height: 100%;
            overflow: hidden;
            flex-direction: row; 
        }

        .setup-sidebar {
            width: 280px;
            background-color: var(--color-bg-secondary);
            flex-shrink: 0;
            height: 100%;
            overflow-y: auto;
            border-right: 1px solid var(--color-border);
        }

        .setup-content {
            flex: 1;
            background-color: var(--color-bg-primary);
            height: 100%;
            overflow-y: auto;
            min-height: 0;
        }

        /* KPæ§åˆ¶å° - æ— é˜´å½± */
        .kp-panel {
            position: fixed;
            top: 56px;
            right: 0;
            bottom: 0;
            width: 350px;
            background: var(--color-bg-primary);
            border-left: 2px solid var(--color-enemy);
            z-index: 100;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            overflow-y: auto;
        }
        .kp-panel.open { transform: translateX(0); }

        /* æ»šåŠ¨æ¡ - ç®€åŒ–æ ·å¼ */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* æ­¦å™¨å¡ç‰‡ - ç›´è§’è®¾è®¡ */
        .weapon-card {
            border: 1px solid var(--color-border);
            padding: 12px;
            margin-bottom: 8px;
            background: var(--color-bg-primary);
            transition: border-color 0.2s;
        }
        .weapon-card.active { border-color: var(--color-player); border-width: 2px; }

        /* æŠ€èƒ½é¡¹ - ç›´è§’è®¾è®¡ */
        .skill-item {
            display: flex; 
            align-items: center; 
            justify-content: space-between;
            padding: 8px; 
            margin-bottom: 4px;
            background: #f8fafc; 
            border: 1px solid #e2e8f0;
        }
        .skill-item.multi-target {
            background: #fef3c7;
            border-color: #f59e0b;
        }

        /* =====================================================
           é˜µè¥è‰²æ¡ (Faction Strip)
           ===================================================== */
        .faction-strip-player {
            border-left: var(--faction-strip-width) solid var(--color-player) !important;
        }
        .faction-strip-enemy {
            border-left: var(--faction-strip-width) solid var(--color-enemy) !important;
        }

        /* =====================================================
           é€‰ä¸­çŠ¶æ€ (Selected State) - åè‰²è®¾è®¡
           ===================================================== */
        .char-card {
            background: var(--color-bg-primary);
            color: var(--color-text-primary);
            border: 1px solid var(--color-border);
            transition: all 0.15s ease;
            cursor: pointer;
        }
        
        .char-card.selected-player {
            background: var(--color-player);
            color: #fff;
            border: 2px solid #000;
        }
        
        .char-card.selected-enemy {
            background: var(--color-enemy);
            color: #fff;
            border: 2px solid #000;
        }

        /* =====================================================
           è‡ªå®šä¹‰æ•°å­—é”®ç›˜ (CustomNumPad)
           ===================================================== */
        .numpad-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 200;
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }
        
        .numpad-container {
            background: var(--color-bg-primary);
            width: 100%;
            max-width: 400px;
            border-top: 2px solid var(--color-border-strong);
            padding: 16px;
            padding-bottom: calc(16px + env(safe-area-inset-bottom, 0));
        }
        
        .numpad-display {
            font-size: 32px;
            font-family: ui-monospace, monospace;
            text-align: center;
            padding: 12px;
            border: 1px solid var(--color-border);
            margin-bottom: 12px;
            min-height: 56px;
        }
        
        .numpad-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        
        .numpad-btn {
            height: 56px;
            font-size: 20px;
            font-weight: bold;
            border: 1px solid var(--color-border);
            background: var(--color-bg-primary);
            cursor: pointer;
            transition: background 0.1s;
        }
        .numpad-btn:active { background: #e5e7eb; }
        .numpad-btn.confirm { background: #000; color: #fff; }
        .numpad-btn.confirm:active { background: #333; }

        .numpad-quick {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        .numpad-quick button {
            flex: 1;
            padding: 8px;
            font-size: 12px;
            font-weight: bold;
            border: 1px solid var(--color-border);
            background: #f3f4f6;
            cursor: pointer;
        }

        /* =====================================================
           çŠ¶æ€ç½‘æ ¼ (StatusGrid)
           ===================================================== */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 4px;
        }
        
        .status-btn {
            padding: 6px 4px;
            font-size: 10px;
            font-weight: bold;
            text-align: center;
            border: 1px solid var(--color-border);
            background: #f9fafb;
            color: #9ca3af;
            cursor: pointer;
            transition: all 0.15s;
        }
        .status-btn.active-danger {
            background: var(--color-enemy);
            color: #fff;
            border-color: var(--color-enemy);
        }
        .status-btn.active-dark {
            background: #000;
            color: #fff;
            border-color: #000;
        }

        /* =====================================================
           ç§»åŠ¨ç«¯é€‚é…
           ===================================================== */
        @media (max-width: 1024px) {
            input, select, textarea { font-size: 16px !important; }

            @media (orientation: portrait) {
                .combat-grid {
                    display: flex;
                    flex-direction: column;
                    height: 100%;
                    width: 100%;
                }

                .panel-left, .panel-center, .panel-right {
                    display: none; 
                    width: 100%;
                    height: 100%;
                    border: none;
                }

                .panel-mobile-active {
                    display: flex !important;
                    flex-direction: column;
                }

                .setup-grid {
                    flex-direction: column !important;
                    min-height: 0;
                }

                .setup-sidebar {
                    width: 100% !important;
                    height: auto !important;
                    max-height: 35dvh;
                    border-right: none !important;
                    border-bottom: 1px solid var(--color-border);
                    flex: 0 0 auto;
                    overflow-y: auto !important;
                }

                .setup-content {
                    width: 100% !important;
                    flex: 1 1 0; 
                    min-height: 0;
                    overflow-y: auto !important;
                    padding: 16px !important;
                    padding-bottom: 80px !important;
                    -webkit-overflow-scrolling: touch;
                }

                .mobile-nav { display: flex !important; }

                .centered-card {
                    width: 95%;
                    max-height: none;
                    flex: 1;
                    display: flex;
                    flex-direction: column;
                }
                .centered-card > div { overflow-y: visible; }
            }

            @media (orientation: landscape) {
                .combat-grid {
                    display: grid !important;
                    grid-template-columns: 200px 1fr 240px !important; 
                    height: 100%;
                }

                .panel-left, .panel-center, .panel-right {
                    display: flex !important;
                    height: 100% !important;
                    position: static !important;
                }

                .mobile-nav { display: none !important; }

                .setup-grid {
                    flex-direction: row !important;
                }

                .setup-sidebar {
                    width: 220px !important;
                    height: 100% !important;
                    max-height: none !important;
                    border-right: 1px solid var(--color-border) !important;
                    border-bottom: none !important;
                    overflow-y: auto;
                }

                .setup-content {
                    flex: 1 1 0;
                    height: 100% !important;
                    padding-bottom: 20px !important;
                    overflow-y: auto;
                    min-height: 0;
                }
                
                .centered-card {
                    max-height: 90%;
                }
            }
            
            .kp-panel { width: 100%; top: 0; }
            .kp-panel.open { padding-top: 56px; }
        }

        @media (max-height: 500px) and (orientation: portrait) {
            header { display: none; }
            .setup-sidebar { display: none; }
        }

        /* ç‚¹å‡»å¯ç¼–è¾‘æ•°å€¼æ ·å¼ */
        .editable-value {
            cursor: pointer;
            padding: 2px 4px;
            border: 1px dashed transparent;
            transition: border-color 0.15s;
        }
        .editable-value:hover {
            border-color: #9ca3af;
        }

        /* æ—¥å¿—æ ·å¼ - ç›´è§’ */
        .log-item {
            padding: 10px;
            border: 1px solid var(--color-border);
            margin-bottom: 8px;
            font-size: 12px;
            line-height: 1.5;
        }
        .log-item.damage { background: #fef2f2; border-color: #fecaca; color: #991b1b; }
        .log-item.success { background: #f0fdf4; border-color: #bbf7d0; color: #166534; }
        .log-item.roll { background: #fff; border-color: #e5e7eb; color: #374151; font-family: ui-monospace, monospace; }
        .log-item.system { background: #eff6ff; border-color: #bfdbfe; color: #1e40af; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
const { useState, useEffect, useMemo, useRef } = React;

// =====================================================
// å¸¸é‡å®šä¹‰ - æŒ‰å¼€å‘æ–‡æ¡£v1.1æ›´æ–°
// =====================================================
const BASE_CHARACTER = {
    str: 50, con: 50, siz: 60, dex: 50,
    fight: 50, firearms: 20, dodge: 25,
    // æ–°å¢ï¼šåŒ»ç–—æŠ€èƒ½
    firstAid: 30, medicine: 5,
    armorValue: 0, hasGunReady: false,
    // æ–°è®¾è®¡ï¼šåˆ†ç¦»è¿‘æˆ˜/è¿œç¨‹æ­¦å™¨æ§½
    meleeWeapon: { name: "æ‹³å¤´", damage: "1D3", type: "melee", impale: false },
    rangedWeapon: null,
    weapons: [], 
    customSkills: [], 
    status: { 
        majorWound: false, 
        dying: false, 
        unconscious: false, 
        prone: false, 
        defenseUsedThisRound: false 
    }
};

const MELEE_WEAPONS = [
    { name: "æ‹³å¤´", damage: "1D3", type: "melee", impale: false },
    { name: "å°åˆ€", damage: "1D4", type: "melee", impale: true },
    { name: "åŒ•é¦–", damage: "1D4+2", type: "melee", impale: true },
    { name: "æ£’çƒæ£", damage: "1D8", type: "melee", impale: false },
    { name: "æ–§å¤´", damage: "1D8+2", type: "melee", impale: true },
    { name: "é•¿å‰‘", damage: "1D8+1", type: "melee", impale: true },
    { name: "æˆ˜é”¤", damage: "1D8+2", type: "melee", impale: false },
    { name: "é•¿çŸ›", damage: "1D8+1", type: "melee", impale: true },
    { name: "å¤§åˆ€", damage: "1D8", type: "melee", impale: true },
    { name: "ç”©æ£", damage: "1D8", type: "melee", impale: false },
];

const RANGED_WEAPONS = [
    { name: ".38å·¦è½®", damage: "1D10", type: "ranged", impale: true, range: 15, ammo: 6, maxAmmo: 6, malfunction: 100 },
    { name: ".45è‡ªåŠ¨æ‰‹æª", damage: "1D10+2", type: "ranged", impale: true, range: 15, ammo: 7, maxAmmo: 7, malfunction: 100 },
    { name: "9mmæ‰‹æª", damage: "1D10", type: "ranged", impale: true, range: 15, ammo: 15, maxAmmo: 15, malfunction: 98 },
    { name: "æ­¥æª", damage: "2D6+4", type: "ranged", impale: true, range: 110, ammo: 5, maxAmmo: 5, malfunction: 100 },
    { name: "éœ°å¼¹æª", damage: "4D6", type: "ranged", impale: false, range: 10, ammo: 2, maxAmmo: 2, malfunction: 100 },
    { name: "å†²é”‹æª", damage: "1D10", type: "ranged", impale: true, range: 20, ammo: 30, maxAmmo: 30, malfunction: 96, autoFire: true },
    { name: "å¼©", damage: "1D8+2", type: "ranged", impale: true, range: 50, ammo: 1, maxAmmo: 1, malfunction: 96 },
    { name: "å¼“", damage: "1D6", type: "ranged", impale: false, range: 30, ammo: 1, maxAmmo: 1, malfunction: 97 },
];

const WEAPON_PRESETS = [...MELEE_WEAPONS, ...RANGED_WEAPONS];

const SKILL_TEMPLATES = [
    { id: 'fire_burst', name: 'ç«åŠ›å‹åˆ¶', description: 'å¯¹å¤šä¸ªç›¸é‚»ç›®æ ‡è¿›è¡Œå°„å‡»', type: 'multi_attack', baseCost: 3, maxTargets: 3, difficultyModifier: 1, damageModifier: 0.8 },
    { id: 'aimed_shot', name: 'ç²¾å‡†å°„å‡»', description: 'èŠ±è´¹1è½®ç„å‡†ï¼Œä¸‹è½®è·å¾—å¥–åŠ±éª°', type: 'buff', duration: 1, effect: { bonusDice: 1 } },
    { id: 'berserker_rage', name: 'ç‹‚æš´', description: 'å¢åŠ è¿‘æˆ˜ä¼¤å®³ä½†é™ä½é˜²å¾¡', type: 'buff', duration: 3, effect: { damageBonus: 4, dodgePenalty: 2 } },
];

// =====================================================
// å·¥å…·å‡½æ•°
// =====================================================
const rollDice = (expr) => {
    const match = expr.match(/(\d+)[dD](\d+)(?:\+(\d+))?(?:\-(\d+))?/);
    if (!match) return { total: parseInt(expr) || 0, rolls: [] };
    const [, numStr, sidesStr, plusStr, minusStr] = match;
    const num = parseInt(numStr), sides = parseInt(sidesStr);
    const plus = parseInt(plusStr) || 0, minus = parseInt(minusStr) || 0;
    const rolls = Array(num).fill().map(() => Math.floor(Math.random() * sides) + 1);
    return { total: rolls.reduce((s, r) => s + r, 0) + plus - minus, rolls };
};

const getMaxDamage = (expr) => {
    const match = expr.match(/(\d+)[dD](\d+)(?:\+(\d+))?(?:\-(\d+))?/);
    if (!match) return parseInt(expr) || 0;
    const [, numStr, sidesStr, plusStr, minusStr] = match;
    const num = parseInt(numStr), sides = parseInt(sidesStr);
    const plus = parseInt(plusStr) || 0, minus = parseInt(minusStr) || 0;
    return num * sides + plus - minus;
};

const calcDerived = (c) => {
    const hp = Math.floor((c.con + c.siz) / 10);
    const mov = c.str < c.siz && c.dex < c.siz ? 7 : c.str > c.siz && c.dex > c.siz ? 9 : 8;
    const sum = c.str + c.siz;
    let db = '0', build = 0;
    if (sum <= 64) { db = '-2'; build = -2; }
    else if (sum <= 84) { db = '-1'; build = -1; }
    else if (sum <= 124) { db = '0'; build = 0; }
    else if (sum <= 164) { db = '1D4'; build = 1; }
    else if (sum <= 204) { db = '1D6'; build = 2; }
    else if (sum <= 284) { db = '2D6'; build = 3; }
    else if (sum <= 364) { db = '3D6'; build = 4; }
    else { db = '4D6'; build = 5; }
    return { maxHp: hp, mov, db, build };
};

// COC7è§„åˆ™ï¼šæˆåŠŸç­‰çº§è®¡ç®—
const calculateSuccessLevel = (roll, skill) => {
    if (roll === 1) return 4;  // å¤§æˆåŠŸ
    if (roll <= Math.floor(skill / 5)) return 3;  // æéš¾æˆåŠŸ
    if (roll <= Math.floor(skill / 2)) return 2;  // å›°éš¾æˆåŠŸ
    if (roll <= skill) return 1;  // å¸¸è§„æˆåŠŸ
    if (skill < 50 && roll >= 96) return -1;  // å¤§å¤±è´¥
    if (roll === 100) return -1;  // å¤§å¤±è´¥
    return 0;  // å¤±è´¥
};

const getSuccessLabel = (level) => ({ 
    4: 'å¤§æˆåŠŸ', 
    3: 'æéš¾æˆåŠŸ', 
    2: 'å›°éš¾æˆåŠŸ', 
    1: 'å¸¸è§„æˆåŠŸ', 
    0: 'å¤±è´¥', 
    '-1': 'å¤§å¤±è´¥' 
}[level] || 'æœªçŸ¥');

// å¯¹æŠ—æ£€å®š
const executeOpposedCheck = (atkSkill, defSkill, atkRoll, defRoll, defType) => {
    const atkLvl = calculateSuccessLevel(atkRoll, atkSkill);
    const defLvl = calculateSuccessLevel(defRoll, defSkill);
    if (atkLvl > defLvl) return { success: true, winner: 'attacker', atkLvl, defLvl };
    if (defLvl > atkLvl) return { success: false, winner: 'defender', atkLvl, defLvl };
    // å¹³å±€ï¼šåå‡»æ—¶æ”»å‡»æ–¹èƒœï¼Œé—ªé¿æ—¶é˜²å¾¡æ–¹èƒœ
    return { success: defType === 'counter', winner: defType === 'counter' ? 'attacker' : 'defender', atkLvl, defLvl, isTie: true };
};

// ä¼¤å®³è®¡ç®—ï¼ˆå«è´¯ç©¿è§„åˆ™ï¼‰
const calculateDamage = (weapon, attacker, successLevel, isCounterAttack) => {
    // åå‡»ä¸èƒ½é€ æˆæé™ä¼¤å®³
    if (isCounterAttack) successLevel = Math.min(successLevel, 2);
    
    const wDmg = rollDice(weapon.damage);
    const dbDmg = attacker.db !== '0' ? rollDice(attacker.db) : { total: 0, rolls: [] };
    let total = wDmg.total + dbDmg.total;
    let log = `${wDmg.total}(æ­¦å™¨)`;
    if (dbDmg.total !== 0) log += ` + ${dbDmg.total}(DB)`;
    
    // æéš¾æˆåŠŸï¼šè´¯ç©¿æˆ–æœ€å¤§ä¼¤å®³
    if (successLevel >= 3) {
        const maxW = getMaxDamage(weapon.damage);
        const maxDB = attacker.db !== '0' ? getMaxDamage(attacker.db) : 0;
        if (weapon.impale) {
            // è´¯ç©¿æ­¦å™¨ï¼šæœ€å¤§ä¼¤å®³ + é¢å¤–æ­¦å™¨ä¼¤å®³
            const extra = rollDice(weapon.damage);
            total = maxW + maxDB + extra.total;
            log = `${maxW}(æœ€å¤§)+${maxDB}(DB)+${extra.total}(è´¯ç©¿)`;
        } else {
            // éè´¯ç©¿æ­¦å™¨ï¼šæœ€å¤§ä¼¤å®³
            total = maxW + maxDB;
            log = `${maxW}(æœ€å¤§)+${maxDB}(DB)`;
        }
    }
    return { total: Math.max(0, total), damageLog: log };
};

const generateId = () => Math.random().toString(36).substr(2, 9);

// =====================================================
// æ–°å¢ç»„ä»¶: CustomNumPad (è‡ªå®šä¹‰æ•°å­—é”®ç›˜)
// =====================================================
function CustomNumPad({ isOpen, value, onChange, onConfirm, onClose, label, quickActions }) {
    if (!isOpen) return null;
    
    const handleKey = (key) => {
        if (key === 'back') {
            onChange(value.slice(0, -1));
        } else {
            onChange(value + key);
        }
    };

    return (
        <div className="numpad-overlay" onClick={onClose}>
            <div className="numpad-container" onClick={e => e.stopPropagation()}>
                {label && <div className="text-xs font-bold text-gray-500 mb-2 text-center uppercase">{label}</div>}
                <div className="numpad-display">{value || '0'}</div>
                <div className="numpad-grid">
                    {['1','2','3','4','5','6','7','8','9','back','0','âœ“'].map(k => (
                        <button 
                            key={k} 
                            className={`numpad-btn ${k === 'âœ“' ? 'confirm' : ''}`}
                            onClick={() => k === 'âœ“' ? onConfirm() : handleKey(k)}
                        >
                            {k === 'back' ? 'â†' : k}
                        </button>
                    ))}
                </div>
                {quickActions && (
                    <div className="numpad-quick">
                        {quickActions.map((action, i) => (
                            <button key={i} onClick={action.action}>{action.label}</button>
                        ))}
                    </div>
                )}
            </div>
        </div>
    );
}

// =====================================================
// æ–°å¢ç»„ä»¶: SmartInput (æ™ºèƒ½è¾“å…¥åˆ†æµ)
// =====================================================
function SmartInput({ type, value, onChange, label, placeholder, className }) {
    const [numPadOpen, setNumPadOpen] = useState(false);
    const [tempValue, setTempValue] = useState(String(value));
    
    useEffect(() => {
        setTempValue(String(value));
    }, [value]);

    if (type === 'text') {
        return (
            <div className={className}>
                {label && <label className="text-[10px] uppercase text-gray-400 font-bold mb-0.5 block">{label}</label>}
                <input 
                    type="text" 
                    value={value} 
                    onChange={e => onChange(e.target.value)}
                    placeholder={placeholder}
                    className="w-full py-1 bg-transparent border-b border-gray-200 text-sm focus:outline-none focus:border-black"
                />
            </div>
        );
    }

    // æ•°å­—ç±»å‹ï¼šç‚¹å‡»å”¤èµ·CustomNumPad
    return (
        <div className={className}>
            {label && <label className="text-[10px] uppercase text-gray-400 font-bold mb-0.5 block">{label}</label>}
            <div 
                className="editable-value w-full py-1 border-b border-gray-200 text-sm font-mono"
                onClick={() => { setTempValue(String(value)); setNumPadOpen(true); }}
            >
                {value}
            </div>
            <CustomNumPad 
                isOpen={numPadOpen}
                value={tempValue}
                onChange={setTempValue}
                onConfirm={() => { onChange(parseInt(tempValue) || 0); setNumPadOpen(false); }}
                onClose={() => setNumPadOpen(false)}
                label={label}
                quickActions={[
                    { label: '+1', action: () => setTempValue(String((parseInt(tempValue)||0)+1)) },
                    { label: '-1', action: () => setTempValue(String(Math.max(0,(parseInt(tempValue)||0)-1))) },
                    { label: 'ğŸ²1D10', action: () => setTempValue(String(Math.floor(Math.random()*10)+1)) },
                ]}
            />
        </div>
    );
}

// =====================================================
// æ–°å¢ç»„ä»¶: StatusGrid (çŠ¶æ€ç½‘æ ¼)
// =====================================================
function StatusGrid({ status, onChange }) {
    const statuses = [
        { key: 'majorWound', label: 'é‡ä¼¤', type: 'danger' },
        { key: 'dying', label: 'æ¿’æ­»', type: 'danger' },
        { key: 'unconscious', label: 'æ˜è¿·', type: 'dark' },
        { key: 'prone', label: 'å€’åœ°', type: 'dark' },
    ];

    return (
        <div className="status-grid">
            {statuses.map(s => (
                <button
                    key={s.key}
                    className={`status-btn ${status[s.key] ? (s.type === 'danger' ? 'active-danger' : 'active-dark') : ''}`}
                    onClick={() => onChange({ ...status, [s.key]: !status[s.key] })}
                >
                    {s.label}
                </button>
            ))}
        </div>
    );
}

// =====================================================
// æ–°å¢ç»„ä»¶: EditableValue (ç‚¹å‡»å³æ”¹)
// =====================================================
function EditableValue({ value, onChange, label }) {
    const [editing, setEditing] = useState(false);
    const [tempValue, setTempValue] = useState(String(value));

    useEffect(() => {
        setTempValue(String(value));
    }, [value]);

    return (
        <>
            <span 
                className="editable-value font-mono cursor-pointer"
                onClick={() => { setTempValue(String(value)); setEditing(true); }}
            >
                {value}
            </span>
            <CustomNumPad 
                isOpen={editing}
                value={tempValue}
                onChange={setTempValue}
                onConfirm={() => { onChange(parseInt(tempValue) || 0); setEditing(false); }}
                onClose={() => setEditing(false)}
                label={label}
            />
        </>
    );
}

// =====================================================
// å¥–åŠ±éª°/æƒ©ç½šéª°è§„åˆ™è¯´æ˜å¼¹çª—
// =====================================================
function DiceModifierPopover({ isOpen, onClose }) {
    if (!isOpen) return null;
    
    return (
        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onClick={onClose}>
            <div className="bg-white max-w-lg w-full max-h-[80vh] overflow-y-auto border-2 border-black" onClick={e => e.stopPropagation()}>
                <div className="p-4 border-b border-black bg-black text-white flex justify-between items-center">
                    <h2 className="font-bold">å¥–åŠ±éª°ä¸æƒ©ç½šéª°è§„åˆ™</h2>
                    <button onClick={onClose} className="text-2xl leading-none">&times;</button>
                </div>
                <div className="p-4 text-sm space-y-4">
                    <div>
                        <h3 className="font-bold mb-2">åŸºæœ¬æœºåˆ¶</h3>
                        <p className="text-gray-600">æŠ•æ·1ä¸ªä¸ªä½éª°å’Œ2ä¸ªåä½éª°ï¼Œå¥–åŠ±éª°å–è¾ƒå°(å¥½)ç»“æœï¼Œæƒ©ç½šéª°å–è¾ƒå¤§(å·®)ç»“æœã€‚1ä¸ªå¥–åŠ±éª°ä¸1ä¸ªæƒ©ç½šéª°äº’ç›¸æŠµæ¶ˆã€‚</p>
                    </div>
                    <div>
                        <h3 className="font-bold mb-2 text-green-700">å¥–åŠ±éª°æƒ…å†µ</h3>
                        <ul className="text-gray-600 space-y-1">
                            <li>â€¢ æŠµè¿‘å°„å‡»ï¼šç›®æ ‡åœ¨DEX/5è‹±å°ºå†…</li>
                            <li>â€¢ ç„å‡†ï¼šæ”¾å¼ƒæœ¬è½®è¡ŒåŠ¨ç„å‡†</li>
                            <li>â€¢ ç›®æ ‡å·¨å¤§ï¼šä½“æ ¼4+</li>
                            <li>â€¢ æ”»å‡»å€’åœ°ç›®æ ‡</li>
                            <li>â€¢ å¯¡ä¸æ•Œä¼—ï¼šç›®æ ‡æœ¬è½®å·²é˜²å¾¡è¿‡</li>
                        </ul>
                    </div>
                    <div>
                        <h3 className="font-bold mb-2 text-red-700">æƒ©ç½šéª°æƒ…å†µ</h3>
                        <ul className="text-gray-600 space-y-1">
                            <li>â€¢ æ©ä½“ï¼šç›®æ ‡éƒ¨åˆ†æ©è”½</li>
                            <li>â€¢ é«˜é€Ÿç§»åŠ¨ï¼šMOV 8+</li>
                            <li>â€¢ ç›®æ ‡æå°ï¼šä½“æ ¼-2</li>
                            <li>â€¢ æ‰‹æªè¿å°„</li>
                            <li>â€¢ ç§»åŠ¨å°„å‡»</li>
                            <li>â€¢ è‡ªåŠ¨å°„å‡»ï¼šæ¯ç»„å¼¹å¹•+1æƒ©ç½šéª°</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    );
}

// =====================================================
// ä¸»åº”ç”¨ç»„ä»¶
// =====================================================
function App() {
    const [view, setView] = useState('setup');
    const [characters, setCharacters] = useState([]);
    const [logs, setLogs] = useState([]);
    const [drawerOpen, setDrawerOpen] = useState(false);
    const [turn, setTurn] = useState({ round: 1, index: 0 });
    const [history, setHistory] = useState([]);
    const [kpPanelOpen, setKpPanelOpen] = useState(false);
    const logContainerRef = useRef(null);

    useEffect(() => {
        if (logContainerRef.current) {
            const { scrollHeight, clientHeight } = logContainerRef.current;
            if (scrollHeight > clientHeight) {
                logContainerRef.current.scrollTop = scrollHeight;
            }
        }
    }, [logs]);

    const saveToHistory = () => {
        setHistory(prev => [...prev.slice(-19), {
            characters: JSON.parse(JSON.stringify(characters)),
            turn: { ...turn },
            logs: [...logs]
        }]);
    };

    const undo = () => {
        if (history.length === 0) return;
        const last = history[history.length - 1];
        setCharacters(last.characters);
        setTurn(last.turn);
        setLogs(last.logs);
        setHistory(prev => prev.slice(0, -1));
    };

    const addLog = (text, type = 'info') => {
        setLogs(prev => [...prev, { id: Date.now(), text, type, time: new Date().toLocaleTimeString().slice(0, 8) }]);
    };

    const combatOrder = useMemo(() => [...characters].sort((a, b) => {
        const aDex = a.hasGunReady ? a.dex + 50 : a.dex;
        const bDex = b.hasGunReady ? b.dex + 50 : b.dex;
        return bDex !== aDex ? bDex - aDex : b.fight - a.fight;
    }), [characters]);

    const currentActor = useMemo(() => combatOrder[turn.index % combatOrder.length], [combatOrder, turn.index]);

    const updateChar = (id, updates) => {
        setCharacters(prev => prev.map(c => {
            if (c.id !== id) return c;
            const updated = { ...c, ...updates };
            const derived = calcDerived(updated);
            return { ...updated, ...derived, hp: Math.min(updated.hp, derived.maxHp) };
        }));
    };

    const startNewRound = () => {
        setCharacters(prev => prev.map(c => ({ ...c, status: { ...c.status, defenseUsedThisRound: false } })));
    };

    return (
        <div className="main-layout font-sans text-gray-900 bg-gray-100">
            <header className="h-14 border-b border-gray-200 flex items-center justify-between px-4 bg-white shrink-0 z-30 relative">
                <div className="flex items-center gap-2">
                    <div className="w-6 h-6 bg-black flex items-center justify-center text-white font-bold text-xs">C7</div>
                    <h1 className="font-bold text-base hidden sm:block">COC7 æˆ˜æ–—æ§åˆ¶å° <span className="text-gray-400 font-normal text-xs">v3.0</span></h1>
                    <h1 className="font-bold text-base sm:hidden">COC7</h1>
                </div>
                <div className="flex items-center gap-3">
                    {view === 'setup' && (
                        <button onClick={() => { if(characters.length<1) return alert("è‡³å°‘æ·»åŠ ä¸€ä¸ªè§’è‰²"); setView('combat'); addLog("ğŸ æˆ˜æ–—å¼€å§‹", "system"); }} className="bg-black text-white px-3 py-1.5 text-xs font-bold hover:bg-gray-800">âš”ï¸ å¯åŠ¨</button>
                    )}
                    {view === 'combat' && (
                        <>
                            <span className="font-mono text-xs text-gray-500 bg-gray-100 px-2 py-1 border border-gray-200">R{turn.round}</span>
                            <button onClick={() => setKpPanelOpen(!kpPanelOpen)} className={`font-bold text-xs px-2 py-1 border transition-colors ${kpPanelOpen ? 'bg-red-600 text-white border-red-600' : 'bg-red-50 text-red-600 border-red-200 hover:bg-red-100'}`}>
                                ğŸ‘‘ KP
                            </button>
                            <button onClick={undo} disabled={history.length === 0} className="text-orange-600 font-bold text-xs bg-orange-50 px-2 py-1 border border-orange-200 disabled:opacity-40 hover:bg-orange-100 hidden sm:block">â†©ï¸ æ’¤é”€</button>
                            <button onClick={() => setView('setup')} className="text-gray-500 text-xs hover:text-black underline">è®¾ç½®</button>
                            <button onClick={() => setDrawerOpen(true)} className="text-blue-600 font-bold text-xs bg-blue-50 px-2 py-1 border border-blue-200 hover:bg-blue-100">ğŸ¥</button>
                        </>
                    )}
                </div>
            </header>

            <main className="flex-1 overflow-hidden relative">
                {view === 'setup' ? (
                    <SetupModule characters={characters} setCharacters={setCharacters} updateChar={updateChar} />
                ) : (
                    <CombatModule 
                        characters={characters} 
                        combatOrder={combatOrder}
                        updateChar={updateChar}
                        turn={turn} 
                        setTurn={setTurn}
                        logs={logs}
                        addLog={addLog}
                        currentActor={currentActor}
                        startNewRound={startNewRound}
                        saveToHistory={saveToHistory}
                        logContainerRef={logContainerRef}
                    />
                )}
                <MedicalDrawer isOpen={drawerOpen} onClose={() => setDrawerOpen(false)} characters={characters} updateChar={updateChar} addLog={addLog} />
                
                <KPControlPanel 
                    isOpen={kpPanelOpen} 
                    onClose={() => setKpPanelOpen(false)}
                    characters={characters}
                    updateChar={updateChar}
                    addLog={addLog}
                    currentActor={currentActor}
                />
            </main>
        </div>
    );
}

// =====================================================
// KPæ§åˆ¶å°ç»„ä»¶
// =====================================================
function KPControlPanel({ isOpen, onClose, characters, updateChar, addLog, currentActor }) {
    const [selectedCharId, setSelectedCharId] = useState('');
    const [editMode, setEditMode] = useState('stats');
    const [newWeapon, setNewWeapon] = useState({ name: '', damage: '1D6', type: 'melee', impale: false });
    const [newSkill, setNewSkill] = useState({ name: '', description: '', type: 'single_attack' });

    const selectedChar = characters.find(c => c.id === selectedCharId) || currentActor;

    useEffect(() => {
        if (isOpen && !selectedCharId && currentActor) {
            setSelectedCharId(currentActor.id);
        }
    }, [isOpen, currentActor, selectedCharId]);

    const handleStatChange = (field, value) => {
        if (selectedChar) {
            updateChar(selectedChar.id, { [field]: value });
            addLog(`ğŸ‘‘ KPä¿®æ”¹${selectedChar.name}çš„${field}: ${value}`, 'system');
        }
    };

    const quickActions = {
        heal: (amount) => {
            if (selectedChar) {
                const newHp = Math.min(selectedChar.maxHp, selectedChar.hp + amount);
                updateChar(selectedChar.id, { hp: newHp });
                addLog(`ğŸ‘‘ KPæ²»ç–—${selectedChar.name}: +${amount}HP`, 'system');
            }
        },
        damage: (amount) => {
            if (selectedChar) {
                const newHp = Math.max(0, selectedChar.hp - amount);
                updateChar(selectedChar.id, { hp: newHp });
                addLog(`ğŸ‘‘ KPä¼¤å®³${selectedChar.name}: -${amount}HP`, 'system');
            }
        },
        toggleStatus: (status) => {
            if (selectedChar) {
                const newStatus = { ...selectedChar.status, [status]: !selectedChar.status[status] };
                updateChar(selectedChar.id, { status: newStatus });
                addLog(`ğŸ‘‘ KPåˆ‡æ¢${selectedChar.name}çŠ¶æ€: ${status}`, 'system');
            }
        }
    };

    return (
        <div className={`kp-panel ${isOpen ? 'open' : ''}`}>
            <div className="p-4 bg-red-600 text-white flex justify-between items-center">
                <h2 className="font-bold text-lg">ğŸ‘‘ KPæ§åˆ¶å°</h2>
                <button onClick={onClose} className="text-white text-2xl hover:bg-red-700 w-8 h-8 flex items-center justify-center">Ã—</button>
            </div>

            <div className="p-4">
                <div className="mb-6">
                    <label className="block text-sm font-bold text-gray-700 mb-2">é€‰æ‹©è§’è‰²</label>
                    <select 
                        value={selectedCharId} 
                        onChange={(e) => setSelectedCharId(e.target.value)}
                        className="w-full border border-gray-300 px-3 py-2 text-sm"
                    >
                        {characters.map(c => (
                            <option key={c.id} value={c.id}>{c.name} ({c.type === 'player' ? 'è°ƒæŸ¥å‘˜' : 'æ•Œäºº'})</option>
                        ))}
                    </select>
                </div>

                {selectedChar && (
                    <>
                        <div className="flex mb-4 border-b">
                            {['stats', 'weapons', 'skills'].map(mode => (
                                <button
                                    key={mode}
                                    onClick={() => setEditMode(mode)}
                                    className={`px-4 py-2 text-sm font-bold border-b-2 transition-colors ${
                                        editMode === mode 
                                            ? 'border-red-500 text-red-600' 
                                            : 'border-transparent text-gray-500 hover:text-gray-700'
                                    }`}
                                >
                                    {{stats:'å±æ€§',weapons:'æ­¦å™¨',skills:'æŠ€èƒ½'}[mode]}
                                </button>
                            ))}
                        </div>

                        {editMode === 'stats' && (
                            <div className="space-y-6">
                                <div>
                                    <h3 className="text-sm font-bold text-gray-700 mb-3">å¿«æ·æ“ä½œ</h3>
                                    <div className="grid grid-cols-2 gap-2 mb-4">
                                        <button onClick={() => quickActions.heal(5)} className="px-3 py-2 bg-green-100 text-green-700 text-sm hover:bg-green-200 border border-green-200">æ²»ç–— +5</button>
                                        <button onClick={() => quickActions.heal(10)} className="px-3 py-2 bg-green-100 text-green-700 text-sm hover:bg-green-200 border border-green-200">æ²»ç–— +10</button>
                                        <button onClick={() => quickActions.damage(5)} className="px-3 py-2 bg-red-100 text-red-700 text-sm hover:bg-red-200 border border-red-200">ä¼¤å®³ -5</button>
                                        <button onClick={() => quickActions.damage(10)} className="px-3 py-2 bg-red-100 text-red-700 text-sm hover:bg-red-200 border border-red-200">ä¼¤å®³ -10</button>
                                    </div>
                                    
                                    <h3 className="text-sm font-bold text-gray-700 mb-2">çŠ¶æ€åˆ‡æ¢</h3>
                                    <StatusGrid status={selectedChar.status} onChange={(status) => updateChar(selectedChar.id, { status })} />
                                </div>

                                <div>
                                    <h3 className="text-sm font-bold text-gray-700 mb-2">å±æ€§ä¿®æ”¹</h3>
                                    <div className="grid grid-cols-2 gap-2">
                                        {[
                                            { key: 'hp', label: 'HP' },
                                            { key: 'str', label: 'STR' },
                                            { key: 'con', label: 'CON' },
                                            { key: 'siz', label: 'SIZ' },
                                            { key: 'dex', label: 'DEX' },
                                            { key: 'fight', label: 'æ ¼æ–—' },
                                            { key: 'firearms', label: 'å°„å‡»' },
                                            { key: 'dodge', label: 'é—ªé¿' },
                                            { key: 'firstAid', label: 'æ€¥æ•‘' },
                                            { key: 'medicine', label: 'åŒ»å­¦' },
                                        ].map(stat => (
                                            <div key={stat.key} className="flex items-center gap-2">
                                                <span className="text-xs w-12">{stat.label}</span>
                                                <input
                                                    type="number"
                                                    value={selectedChar[stat.key]}
                                                    onChange={(e) => handleStatChange(stat.key, parseInt(e.target.value) || 0)}
                                                    className="flex-1 border border-gray-200 px-2 py-1 text-sm font-mono"
                                                />
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}

                        {editMode === 'weapons' && (
                            <div className="space-y-4">
                                <div>
                                    <h3 className="text-sm font-bold text-gray-700 mb-2">å½“å‰æ­¦å™¨</h3>
                                    <div className="space-y-2">
                                        <div className="p-2 bg-blue-50 border border-blue-200">
                                            <div className="text-xs text-blue-600 font-bold">è¿‘æˆ˜æ­¦å™¨</div>
                                            <div className="font-bold">{selectedChar.meleeWeapon?.name || 'æ‹³å¤´'}</div>
                                        </div>
                                        <div className="p-2 bg-orange-50 border border-orange-200">
                                            <div className="text-xs text-orange-600 font-bold">è¿œç¨‹æ­¦å™¨</div>
                                            <div className="font-bold">{selectedChar.rangedWeapon?.name || 'æ— '}</div>
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <h3 className="text-sm font-bold text-gray-700 mb-2">è£…å¤‡é¢„è®¾æ­¦å™¨</h3>
                                    <select 
                                        onChange={(e) => {
                                            const preset = WEAPON_PRESETS.find(w => w.name === e.target.value);
                                            if (preset) {
                                                if (preset.type === 'melee') {
                                                    updateChar(selectedChar.id, { meleeWeapon: { ...preset } });
                                                } else {
                                                    updateChar(selectedChar.id, { rangedWeapon: { ...preset } });
                                                }
                                                addLog(`ğŸ‘‘ ${selectedChar.name}è£…å¤‡${preset.name}`, 'system');
                                                e.target.value = '';
                                            }
                                        }}
                                        className="w-full border border-gray-200 px-3 py-2 text-sm"
                                    >
                                        <option value="">-- é€‰æ‹©æ­¦å™¨ --</option>
                                        <optgroup label="è¿‘æˆ˜æ­¦å™¨">
                                            {MELEE_WEAPONS.map(w => <option key={w.name} value={w.name}>{w.name} ({w.damage})</option>)}
                                        </optgroup>
                                        <optgroup label="è¿œç¨‹æ­¦å™¨">
                                            {RANGED_WEAPONS.map(w => <option key={w.name} value={w.name}>{w.name} ({w.damage})</option>)}
                                        </optgroup>
                                    </select>
                                </div>
                            </div>
                        )}

                        {editMode === 'skills' && (
                            <div className="space-y-4">
                                <div>
                                    <h3 className="text-sm font-bold text-gray-700 mb-2">æŠ€èƒ½æ¨¡æ¿</h3>
                                    <div className="space-y-2">
                                        {SKILL_TEMPLATES.map(template => (
                                            <button
                                                key={template.id}
                                                onClick={() => {
                                                    const customSkills = [...(selectedChar.customSkills || []), { ...template, id: generateId() }];
                                                    updateChar(selectedChar.id, { customSkills });
                                                    addLog(`ğŸ‘‘ ä¸º${selectedChar.name}æ·»åŠ æŠ€èƒ½: ${template.name}`, 'system');
                                                }}
                                                className="w-full p-2 border border-gray-200 text-left text-sm hover:bg-gray-50"
                                            >
                                                <div className="font-bold">{template.name}</div>
                                                <div className="text-xs text-gray-600">{template.description}</div>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}
                    </>
                )}
            </div>
        </div>
    );
}

// =====================================================
// è®¾ç½®æ¨¡å—
// =====================================================
function SetupModule({ characters, setCharacters, updateChar }) {
    const [selectedId, setSelectedId] = useState(null);
    const [isImporting, setIsImporting] = useState(false);
    const [importText, setImportText] = useState('');
    
    const activeChar = characters.find(c => c.id === selectedId);

    const addCharacter = (type) => {
        const newChar = { 
            ...JSON.parse(JSON.stringify(BASE_CHARACTER)), 
            id: generateId(), 
            type, 
            name: type === 'player' ? 'æ–°è°ƒæŸ¥å‘˜' : 'æ–°æ•Œäºº',
            weapons: [], 
            customSkills: [] 
        };
        const derived = calcDerived(newChar);
        setCharacters(p => [...p, { ...newChar, ...derived, hp: derived.maxHp }]);
        setSelectedId(newChar.id);
    };

    const handleImport = () => {
        if (!importText) return;
        const lines = importText.split('\n');
        const newChar = { ...JSON.parse(JSON.stringify(BASE_CHARACTER)), id: generateId(), type: 'player', name: 'å¯¼å…¥è§’è‰²', weapons: [], customSkills: [] };
        lines.forEach(line => {
            if (line.includes('åŠ›é‡')) newChar.str = parseInt(line.match(/åŠ›é‡\s*(\d+)/)?.[1] || 50);
            if (line.includes('ä½“è´¨')) newChar.con = parseInt(line.match(/ä½“è´¨\s*(\d+)/)?.[1] || 50);
            if (line.includes('ä½“å‹')) newChar.siz = parseInt(line.match(/ä½“å‹\s*(\d+)/)?.[1] || 60);
            if (line.includes('æ•æ·')) newChar.dex = parseInt(line.match(/æ•æ·\s*(\d+)/)?.[1] || 50);
            if (line.includes('æ–—æ®´') || line.includes('æ ¼æ–—')) newChar.fight = parseInt(line.match(/\d+/)?.[0] || 50);
            if (line.includes('å°„å‡»')) newChar.firearms = parseInt(line.match(/\d+/)?.[0] || 20);
            if (line.includes('é—ªé¿')) newChar.dodge = parseInt(line.match(/\d+/)?.[0] || 25);
            if (line.includes('æ€¥æ•‘')) newChar.firstAid = parseInt(line.match(/\d+/)?.[0] || 30);
            if (line.includes('åŒ»å­¦')) newChar.medicine = parseInt(line.match(/\d+/)?.[0] || 5);
        });
        const derived = calcDerived(newChar);
        setCharacters(p => [...p, { ...newChar, ...derived, hp: derived.maxHp }]);
        setSelectedId(newChar.id);
        setImportText('');
        setIsImporting(false);
    };

    return (
        <div className="setup-grid flex h-full divide-x divide-gray-200">
            <div className="setup-sidebar w-64 bg-gray-50 flex flex-col shrink-0 h-full overflow-hidden panel-scroll panel-left">
                <div className="p-3 space-y-4">
                    {isImporting ? (
                        <div className="bg-white p-2 border border-gray-300">
                            <textarea className="w-full h-24 text-xs font-mono border border-gray-200 p-1 mb-2 focus:ring-1 focus:ring-black outline-none" placeholder="ç²˜è´´ .st æ–‡æœ¬..." value={importText} onChange={e => setImportText(e.target.value)} />
                            <div className="flex gap-2">
                                <button onClick={handleImport} className="flex-1 bg-black text-white text-xs py-1 hover:bg-gray-800">ç¡®è®¤</button>
                                <button onClick={() => setIsImporting(false)} className="flex-1 bg-gray-200 text-xs py-1 hover:bg-gray-300">å–æ¶ˆ</button>
                            </div>
                        </div>
                    ) : (
                        <button onClick={() => setIsImporting(true)} className="w-full py-2 border border-dashed border-gray-300 text-gray-400 text-xs hover:border-black hover:text-black transition-colors">ğŸ“¥ ç²˜è´´ .st å¯¼å…¥</button>
                    )}
                    
                    <div>
                        <div className="flex justify-between items-center mb-2">
                            <h3 className="text-xs font-bold text-gray-500 uppercase">è°ƒæŸ¥å‘˜</h3>
                            <button onClick={() => addCharacter('player')} className="text-blue-600 text-xs font-bold hover:bg-blue-50 px-2">+</button>
                        </div>
                        <div className="space-y-1">
                            {characters.filter(c => c.type === 'player').map(c => (
                                <div 
                                    key={c.id} 
                                    onClick={() => setSelectedId(c.id)} 
                                    className={`char-card faction-strip-player flex items-center justify-between px-2 py-1.5 text-xs ${selectedId === c.id ? 'selected-player' : ''}`}
                                >
                                    <span className="font-medium truncate">{c.name}</span>
                                    <button onClick={(e) => { e.stopPropagation(); setCharacters(p => p.filter(x => x.id !== c.id)); }} className="opacity-50 hover:opacity-100">Ã—</button>
                                </div>
                            ))}
                        </div>
                    </div>
                    
                    <div>
                        <div className="flex justify-between items-center mb-2">
                            <h3 className="text-xs font-bold text-gray-500 uppercase">å¨èƒ</h3>
                            <button onClick={() => addCharacter('enemy')} className="text-red-600 text-xs font-bold hover:bg-red-50 px-2">+</button>
                        </div>
                        <div className="space-y-1">
                            {characters.filter(c => c.type === 'enemy').map(c => (
                                <div 
                                    key={c.id} 
                                    onClick={() => setSelectedId(c.id)} 
                                    className={`char-card faction-strip-enemy flex items-center justify-between px-2 py-1.5 text-xs ${selectedId === c.id ? 'selected-enemy' : ''}`}
                                >
                                    <span className="font-medium truncate">{c.name}</span>
                                    <button onClick={(e) => { e.stopPropagation(); setCharacters(p => p.filter(x => x.id !== c.id)); }} className="opacity-50 hover:opacity-100">Ã—</button>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            </div>
            
            <div className="setup-content flex-1 bg-white h-full overflow-y-auto panel-scroll">
                {activeChar ? <CharacterSheet char={activeChar} updateChar={updateChar} /> : (
                    <div className="h-full flex items-center justify-center text-gray-300">
                        <div className="text-center">
                            <div className="text-4xl mb-2 opacity-20">ğŸ—‚ï¸</div>
                            <p className="text-sm">é€‰æ‹©æˆ–åˆ›å»ºè§’è‰²</p>
                        </div>
                    </div>
                )}
            </div>
        </div>
    );
}

// =====================================================
// è§’è‰²è¡¨å•ç»„ä»¶
// =====================================================
function CharacterSheet({ char, updateChar }) {
    const Cell = ({ label, value, field, type="number", readonly=false }) => (
        <div className="flex flex-col">
            <label className="text-[10px] uppercase text-gray-400 font-bold mb-0.5">{label}</label>
            <input 
                type={type} 
                value={value} 
                readOnly={readonly} 
                onChange={(e) => updateChar(char.id, { [field]: type === 'number' ? parseInt(e.target.value)||0 : e.target.value })} 
                className={`w-full py-0.5 bg-transparent border-b border-gray-200 text-sm font-mono focus:outline-none focus:border-black transition-colors ${readonly ? 'text-gray-400 cursor-not-allowed border-dashed' : 'text-gray-900'}`} 
            />
        </div>
    );

    return (
        <div className="max-w-2xl mx-auto p-6">
            <div className="mb-6 flex gap-4 items-end">
                <div className="flex-1">
                    <input type="text" value={char.name} onChange={e => updateChar(char.id, { name: e.target.value })} className="text-2xl font-bold w-full border-b-2 border-black pb-1 focus:outline-none" placeholder="NAME" />
                </div>
                <div className="w-28">
                    <label className="text-xs font-bold text-gray-400">TYPE</label>
                    <select value={char.type} onChange={e => updateChar(char.id, { type: e.target.value })} className="w-full py-1 bg-transparent border-b border-gray-200 text-sm focus:outline-none">
                        <option value="player">PLAYER</option>
                        <option value="enemy">ENEMY</option>
                    </select>
                </div>
            </div>
            
            {/* åŸºç¡€å±æ€§ */}
            <div className="grid grid-cols-2 sm:grid-cols-4 gap-x-4 sm:gap-x-6 gap-y-4 mb-6">
                <Cell label="STR" field="str" value={char.str} />
                <Cell label="CON" field="con" value={char.con} />
                <Cell label="SIZ" field="siz" value={char.siz} />
                <Cell label="DEX" field="dex" value={char.dex} />
                <Cell label="HP(Max)" field="maxHp" value={char.maxHp} readonly />
                <Cell label="DB" field="db" value={char.db} type="text" readonly />
                <Cell label="Build" field="build" value={char.build} readonly />
                <Cell label="MOV" field="mov" value={char.mov} readonly />
            </div>

            {/* æˆ˜æ–—æŠ€èƒ½ */}
            <div className="grid grid-cols-2 sm:grid-cols-4 gap-x-4 sm:gap-x-6 gap-y-4 mb-6">
                <Cell label="æ ¼æ–—" field="fight" value={char.fight} />
                <Cell label="é—ªé¿" field="dodge" value={char.dodge} />
                <Cell label="å°„å‡»" field="firearms" value={char.firearms} />
                <Cell label="æŠ¤ç”²" field="armorValue" value={char.armorValue || 0} />
            </div>

            {/* åŒ»ç–—æŠ€èƒ½ (æ–°å¢) */}
            <div className="grid grid-cols-2 sm:grid-cols-4 gap-x-4 sm:gap-x-6 gap-y-4 mb-6">
                <Cell label="æ€¥æ•‘" field="firstAid" value={char.firstAid || 30} />
                <Cell label="åŒ»å­¦" field="medicine" value={char.medicine || 5} />
            </div>
            
            {/* æªæ¢°å‡†å¤‡ */}
            <div className="mb-4">
                <label className="flex items-center gap-2 cursor-pointer text-sm select-none">
                    <input type="checkbox" checked={char.hasGunReady || false} onChange={e => updateChar(char.id, { hasGunReady: e.target.checked })} className="w-4 h-4" />
                    <span>ğŸ”« æªæ¢°å·²å‡†å¤‡ (DEX+50)</span>
                </label>
            </div>

            {/* çŠ¶æ€ç½‘æ ¼ (æ–°å¢) */}
            <div className="mb-6">
                <h4 className="text-xs font-bold text-gray-900 uppercase mb-2">çŠ¶æ€æ ‡è®°</h4>
                <StatusGrid 
                    status={char.status} 
                    onChange={(status) => updateChar(char.id, { status })} 
                />
            </div>
            
            {/* æ­¦å™¨é…ç½® - æ–°è®¾è®¡ï¼šåˆ†ç¦»è¿‘æˆ˜/è¿œç¨‹ */}
            <div className="border-t border-gray-200 pt-4 mb-6">
                <h4 className="text-xs font-bold text-gray-900 uppercase mb-3">æ­¦å™¨é…ç½®</h4>
                
                {/* è¿‘æˆ˜æ­¦å™¨æ§½ */}
                <div className="mb-4 p-3 bg-blue-50 border border-blue-200">
                    <div className="text-xs font-bold text-blue-600 mb-2">è¿‘æˆ˜æ­¦å™¨</div>
                    <select 
                        className="w-full text-sm bg-white border border-blue-200 py-1 px-2 focus:ring-1 focus:ring-blue-500 outline-none" 
                        value={char.meleeWeapon?.name || 'æ‹³å¤´'} 
                        onChange={(e) => { 
                            const w = MELEE_WEAPONS.find(w => w.name === e.target.value); 
                            if (w) updateChar(char.id, { meleeWeapon: { ...w } }); 
                        }}
                    >
                        {MELEE_WEAPONS.map(w => <option key={w.name} value={w.name}>{w.name} ({w.damage})</option>)}
                    </select>
                </div>

                {/* è¿œç¨‹æ­¦å™¨æ§½ */}
                <div className="p-3 bg-orange-50 border border-orange-200">
                    <div className="text-xs font-bold text-orange-600 mb-2">è¿œç¨‹æ­¦å™¨</div>
                    <select 
                        className="w-full text-sm bg-white border border-orange-200 py-1 px-2 focus:ring-1 focus:ring-orange-500 outline-none" 
                        value={char.rangedWeapon?.name || ''} 
                        onChange={(e) => { 
                            if (e.target.value === '') {
                                updateChar(char.id, { rangedWeapon: null });
                            } else {
                                const w = RANGED_WEAPONS.find(w => w.name === e.target.value); 
                                if (w) updateChar(char.id, { rangedWeapon: { ...w } }); 
                            }
                        }}
                    >
                        <option value="">æ— è¿œç¨‹æ­¦å™¨</option>
                        {RANGED_WEAPONS.map(w => <option key={w.name} value={w.name}>{w.name} ({w.damage}) å°„ç¨‹{w.range}ç </option>)}
                    </select>
                    {char.rangedWeapon && (
                        <div className="mt-2 text-xs text-orange-700">
                            å¼¹è¯: {char.rangedWeapon.ammo}/{char.rangedWeapon.maxAmmo} | æ•…éšœå€¼: {char.rangedWeapon.malfunction}
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
}

// =====================================================
// æˆ˜æ–—æ¨¡å—
// =====================================================
function CombatModule({ characters, combatOrder, updateChar, turn, setTurn, logs, addLog, currentActor, startNewRound, saveToHistory, logContainerRef }) {
    const [phase, setPhase] = useState('select_action');
    const [selectedTargetId, setSelectedTargetId] = useState(null);
    const [combatAction, setCombatAction] = useState(null);
    const [inputValue, setInputValue] = useState('');
    const [shootingDistance, setShootingDistance] = useState(10);
    const [maneuverType, setManeuverType] = useState('disarm');
    const [mobileTab, setMobileTab] = useState('action');
    const [dicePopoverOpen, setDicePopoverOpen] = useState(false);
    const [diceModifier, setDiceModifier] = useState(0); // å¥–åŠ±éª°/æƒ©ç½šéª°è°ƒæ•´

    const targetActor = characters.find(c => c.id === selectedTargetId);

    const nextTurn = () => {
        saveToHistory();
        const nextIndex = turn.index + 1;
        if (nextIndex >= combatOrder.length) {
            setTurn({ round: turn.round + 1, index: 0 });
            startNewRound();
            addLog(`ğŸ“… ç¬¬ ${turn.round + 1} è½®å¼€å§‹`, 'system');
        } else {
            setTurn({ ...turn, index: nextIndex });
        }
        setPhase('select_action');
        setSelectedTargetId(null);
        setCombatAction(null);
        setInputValue('');
        setDiceModifier(0);
    };

    // å¤„ç†è¿‘æˆ˜æ”»å‡»
    const handleMeleeAttack = () => {
        if (!targetActor) return;
        saveToHistory();
        const weapon = currentActor.meleeWeapon || { name: "æ‹³å¤´", damage: "1D3", impale: false };
        setCombatAction({
            type: 'melee',
            attacker: currentActor,
            target: targetActor,
            weapon,
            attackerSkill: currentActor.fight,
        });
        setPhase('waiting_defense');
        addLog(`âš”ï¸ ${currentActor.name} ç”¨ ${weapon.name} æ”»å‡» ${targetActor.name}`, 'system');
    };

    // å¤„ç†å°„å‡»æ”»å‡»
    const handleRangedAttack = () => {
        if (!targetActor || !currentActor.rangedWeapon) return;
        if (currentActor.rangedWeapon.ammo <= 0) {
            addLog(`âŒ ${currentActor.name} çš„ ${currentActor.rangedWeapon.name} æ²¡æœ‰å¼¹è¯ï¼`, 'system');
            return;
        }
        saveToHistory();
        const weapon = currentActor.rangedWeapon;
        
        // è®¡ç®—å°„å‡»éš¾åº¦
        let difficulty = 'regular';
        if (shootingDistance > weapon.range * 2) difficulty = 'extreme';
        else if (shootingDistance > weapon.range) difficulty = 'hard';
        
        setCombatAction({
            type: 'ranged',
            attacker: currentActor,
            target: targetActor,
            weapon,
            distance: shootingDistance,
            difficulty,
        });
        setPhase('input_roll');
        addLog(`ğŸ”« ${currentActor.name} ç”¨ ${weapon.name} å°„å‡» ${targetActor.name} (è·ç¦»:${shootingDistance}ç , éš¾åº¦:${difficulty === 'regular' ? 'å¸¸è§„' : difficulty === 'hard' ? 'å›°éš¾' : 'æéš¾'})`, 'system');
    };

    // å¤„ç†æˆ˜æŠ€
    const handleManeuver = () => {
        if (!targetActor) return;
        saveToHistory();
        
        // ä½“æ ¼å·®æ£€å®š
        const buildDiff = targetActor.build - currentActor.build;
        if (buildDiff >= 3) {
            addLog(`âŒ ä½“æ ¼å·®è·è¿‡å¤§ (${buildDiff})ï¼Œæˆ˜æŠ€æ— æ•ˆï¼`, 'system');
            return;
        }
        
        const penaltyDice = Math.max(0, buildDiff);
        setCombatAction({
            type: 'maneuver',
            attacker: currentActor,
            target: targetActor,
            maneuverType,
            penaltyDice,
            attackerSkill: currentActor.fight,
        });
        setPhase('waiting_defense');
        addLog(`ğŸ¤¼ ${currentActor.name} å¯¹ ${targetActor.name} å‘åŠ¨ ${maneuverType} (æƒ©ç½šéª°:${penaltyDice})`, 'system');
    };

    // å¤„ç†æ”»å‡»æ£€å®š
    const handleRoll = () => {
        const roll = parseInt(inputValue);
        if (!roll || roll < 1 || roll > 100) return;
        
        if (combatAction.type === 'ranged') {
            // å°„å‡»ä¸æ˜¯å¯¹æŠ—æ£€å®š
            let skillValue = currentActor.firearms;
            if (combatAction.difficulty === 'hard') skillValue = Math.floor(skillValue / 2);
            if (combatAction.difficulty === 'extreme') skillValue = Math.floor(skillValue / 5);
            
            const successLevel = calculateSuccessLevel(roll, skillValue);
            
            // æ¶ˆè€—å¼¹è¯
            const newAmmo = currentActor.rangedWeapon.ammo - 1;
            updateChar(currentActor.id, { rangedWeapon: { ...currentActor.rangedWeapon, ammo: newAmmo } });
            
            // æ£€æŸ¥æ•…éšœ
            if (roll >= currentActor.rangedWeapon.malfunction) {
                addLog(`ğŸ’¥ æ­¦å™¨æ•…éšœï¼${currentActor.rangedWeapon.name} å¡å£³äº†ï¼`, 'damage');
                nextTurn();
                return;
            }
            
            if (successLevel > 0) {
                addLog(`ğŸ¯ å‘½ä¸­ï¼[${roll}] ${getSuccessLabel(successLevel)}`, 'roll');
                setCombatAction(prev => ({ ...prev, damageAttacker: currentActor, damageSuccessLevel: successLevel }));
                setPhase('input_damage');
            } else {
                addLog(`ğŸ’¨ æœªå‘½ä¸­ [${roll}] ${getSuccessLabel(successLevel)}`, 'roll');
                nextTurn();
            }
        } else {
            // è¿‘æˆ˜/æˆ˜æŠ€ï¼šè®°å½•æ”»å‡»è€…ç»“æœï¼Œç­‰å¾…é˜²å¾¡
            const successLevel = calculateSuccessLevel(roll, combatAction.attackerSkill);
            addLog(`ğŸ² ${currentActor.name} æ”»å‡» [${roll}] ${getSuccessLabel(successLevel)}`, 'roll');
            setCombatAction(prev => ({ ...prev, attackerRoll: roll, attackerSuccessLevel: successLevel }));
            setPhase('input_defense_roll');
        }
        setInputValue('');
    };

    // å¤„ç†é˜²å¾¡æ£€å®š
    const handleDefenseRoll = () => {
        const roll = parseInt(inputValue);
        if (!roll || roll < 1 || roll > 100) return;
        
        const result = executeOpposedCheck(
            combatAction.attackerSkill,
            combatAction.defenderSkill,
            combatAction.attackerRoll,
            roll,
            combatAction.defenseType
        );
        
        addLog(`ğŸ² ${targetActor.name} é˜²å¾¡ [${roll}] ${getSuccessLabel(result.defLvl)}`, 'roll');
        
        // æ ‡è®°æœ¬è½®å·²é˜²å¾¡
        updateChar(targetActor.id, { status: { ...targetActor.status, defenseUsedThisRound: true } });
        
        if (result.winner === 'attacker') {
            if (combatAction.type === 'maneuver') {
                // æˆ˜æŠ€æˆåŠŸ
                addLog(`âœ… æˆ˜æŠ€æˆåŠŸï¼${combatAction.maneuverType}ç”Ÿæ•ˆ`, 'success');
                if (combatAction.maneuverType === 'knockdown') {
                    updateChar(targetActor.id, { status: { ...targetActor.status, prone: true } });
                }
                nextTurn();
            } else {
                // æ”»å‡»å‘½ä¸­
                setCombatAction(prev => ({ 
                    ...prev, 
                    damageAttacker: currentActor, 
                    damageSuccessLevel: result.atkLvl,
                    isCounterAttack: false 
                }));
                setPhase('input_damage');
            }
        } else {
            if (combatAction.defenseType === 'counter' && result.defLvl > 0) {
                // åå‡»æˆåŠŸ
                addLog(`âš”ï¸ ${targetActor.name} åå‡»æˆåŠŸï¼`, 'success');
                setCombatAction(prev => ({ 
                    ...prev, 
                    damageAttacker: targetActor, 
                    damageSuccessLevel: result.defLvl,
                    isCounterAttack: true,
                    weapon: targetActor.meleeWeapon || { name: "æ‹³å¤´", damage: "1D3", impale: false }
                }));
                setPhase('input_damage');
            } else {
                // é—ªé¿æˆåŠŸæˆ–åŒæ–¹å¤±è´¥
                addLog(`ğŸ’¨ æ”»å‡»è½ç©º`, 'system');
                nextTurn();
            }
        }
        setInputValue('');
    };

    // å¤„ç†ä¼¤å®³
    const handleDamage = () => {
        const damage = parseInt(inputValue) || 0;
        const target = combatAction.isCounterAttack ? currentActor : targetActor;
        const attacker = combatAction.damageAttacker;
        
        // åº”ç”¨æŠ¤ç”²
        const actualDamage = Math.max(0, damage - (target.armorValue || 0));
        const newHp = Math.max(0, target.hp - actualDamage);
        
        // é‡ä¼¤åˆ¤å®š
        const isMajorWound = actualDamage >= Math.floor(target.maxHp / 2);
        let newStatus = { ...target.status };
        
        if (isMajorWound) {
            newStatus.majorWound = true;
            newStatus.prone = true;
            addLog(`ğŸ’€ ${target.name} å—åˆ°é‡ä¼¤ï¼å€’åœ°ï¼`, 'damage');
        }
        
        // æ¿’æ­»åˆ¤å®š
        if (newHp === 0 && newStatus.majorWound) {
            newStatus.dying = true;
            addLog(`âš ï¸ ${target.name} è¿›å…¥æ¿’æ­»çŠ¶æ€ï¼`, 'damage');
        }
        
        // æ­»äº¡åˆ¤å®š
        if (actualDamage >= target.maxHp) {
            addLog(`â˜ ï¸ ${target.name} å½“åœºæ­»äº¡ï¼`, 'damage');
        }
        
        updateChar(target.id, { hp: newHp, status: newStatus });
        addLog(`ğŸ’¥ ${target.name} å—åˆ° ${actualDamage} ç‚¹ä¼¤å®³ (HP: ${target.hp} â†’ ${newHp})`, 'damage');
        
        nextTurn();
    };

    return (
        <div className="combat-grid h-full">
            {/* å·¦ä¾§ï¼šè§’è‰²åˆ—è¡¨ */}
            <div className={`panel-left panel-scroll ${mobileTab === 'status' ? 'panel-mobile-active' : ''}`}>
                <div className="p-3 border-b border-gray-200 text-[10px] font-bold text-gray-400 uppercase bg-white">è¡ŒåŠ¨é¡ºåº</div>
                <div className="p-2 space-y-1">
                    {combatOrder.map((c, i) => {
                        const isActive = i === turn.index % combatOrder.length;
                        const isPlayer = c.type === 'player';
                        return (
                            <div 
                                key={c.id}
                                onClick={() => setSelectedTargetId(c.id)}
                                className={`char-card p-2 ${isPlayer ? 'faction-strip-player' : 'faction-strip-enemy'} ${
                                    selectedTargetId === c.id 
                                        ? (isPlayer ? 'selected-player' : 'selected-enemy') 
                                        : ''
                                } ${isActive ? 'border-2 border-black' : ''}`}
                            >
                                <div className="flex justify-between items-center">
                                    <div>
                                        <div className="font-bold text-sm">{c.name}</div>
                                        <div className="text-xs opacity-70">DEX {c.hasGunReady ? c.dex + 50 : c.dex}</div>
                                    </div>
                                    <div className="text-right">
                                        <div className="font-mono font-bold">{c.hp}/{c.maxHp}</div>
                                        <div className="flex gap-1 mt-1">
                                            {c.status.majorWound && <span className="text-[10px] bg-red-600 text-white px-1">ä¼¤</span>}
                                            {c.status.dying && <span className="text-[10px] bg-red-900 text-white px-1">æ¿’</span>}
                                            {c.status.unconscious && <span className="text-[10px] bg-gray-800 text-white px-1">æ˜</span>}
                                            {c.status.prone && <span className="text-[10px] bg-gray-600 text-white px-1">å€’</span>}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        );
                    })}
                </div>
            </div>

            {/* ä¸­é—´ï¼šæˆ˜æ–—æ“ä½œåŒº */}
            <div className={`panel-center ${mobileTab === 'action' ? 'panel-mobile-active' : ''}`}>
                <div className="target-bar p-3">
                    <div className="flex justify-between items-center">
                        <div>
                            <div className="text-xs text-gray-400 uppercase font-bold">å½“å‰è¡ŒåŠ¨</div>
                            <div className="font-bold text-lg">{currentActor?.name || '-'}</div>
                        </div>
                        <div className="text-right">
                            <div className="text-xs text-gray-400">ç›®æ ‡</div>
                            <div className="font-bold">{targetActor?.name || 'é€‰æ‹©ç›®æ ‡'}</div>
                        </div>
                    </div>
                </div>

                <div className="action-area p-4">
                    <div className="centered-card p-4">
                        {/* é€‰æ‹©è¡ŒåŠ¨é˜¶æ®µ */}
                        {phase === 'select_action' && (
                            <div className="space-y-4">
                                <h3 className="text-center text-sm font-bold border-b pb-2">{currentActor?.name} çš„å›åˆ</h3>
                                
                                {/* ç›®æ ‡é€‰æ‹© */}
                                {!selectedTargetId && (
                                    <div className="text-center text-gray-400 py-4">
                                        â† ä»å·¦ä¾§é€‰æ‹©æ”»å‡»ç›®æ ‡
                                    </div>
                                )}
                                
                                {selectedTargetId && (
                                    <>
                                        {/* è¿‘æˆ˜åŒºå— */}
                                        <div className="border border-blue-200 bg-blue-50 p-3">
                                            <div className="text-xs font-bold text-blue-600 mb-2">è¿‘æˆ˜æ”»å‡»</div>
                                            <button 
                                                onClick={handleMeleeAttack}
                                                className="w-full p-3 bg-blue-600 text-white font-bold text-sm hover:bg-blue-700"
                                            >
                                                âš”ï¸ {currentActor?.meleeWeapon?.name || 'æ‹³å¤´'} ({currentActor?.meleeWeapon?.damage || '1D3'}+DB)
                                            </button>
                                        </div>

                                        {/* å°„å‡»åŒºå— */}
                                        <div className="border border-orange-200 bg-orange-50 p-3">
                                            <div className="text-xs font-bold text-orange-600 mb-2">å°„å‡»æ”»å‡»</div>
                                            {currentActor?.rangedWeapon ? (
                                                <>
                                                    <div className="flex gap-2 mb-2">
                                                        <span className="text-xs">è·ç¦»(ç ):</span>
                                                        <input 
                                                            type="number" 
                                                            value={shootingDistance} 
                                                            onChange={e => setShootingDistance(parseInt(e.target.value) || 10)}
                                                            className="w-16 border border-orange-200 px-1 text-center text-sm"
                                                        />
                                                        <span className="text-xs text-gray-500">
                                                            å°„ç¨‹:{currentActor.rangedWeapon.range} | å¼¹è¯:{currentActor.rangedWeapon.ammo}
                                                        </span>
                                                    </div>
                                                    <button 
                                                        onClick={handleRangedAttack}
                                                        disabled={currentActor.rangedWeapon.ammo <= 0}
                                                        className="w-full p-3 bg-orange-600 text-white font-bold text-sm hover:bg-orange-700 disabled:opacity-50"
                                                    >
                                                        ğŸ”« {currentActor.rangedWeapon.name} ({currentActor.rangedWeapon.damage})
                                                    </button>
                                                </>
                                            ) : (
                                                <div className="text-center text-gray-400 py-2">æ— è¿œç¨‹æ­¦å™¨</div>
                                            )}
                                        </div>

                                        {/* æˆ˜æŠ€åŒºå— */}
                                        <div className="border border-purple-200 bg-purple-50 p-3">
                                            <div className="text-xs font-bold text-purple-600 mb-2">æˆ˜æŠ€</div>
                                            <div className="grid grid-cols-2 gap-2 mb-2">
                                                {[{id:'disarm',n:'ç¼´æ¢°'},{id:'knockdown',n:'å‡»å€’'},{id:'grapple',n:'å‹åˆ¶'},{id:'push',n:'æ¨æ’'}].map(m => (
                                                    <button 
                                                        key={m.id} 
                                                        onClick={() => setManeuverType(m.id)} 
                                                        className={`p-2 border text-xs font-bold ${maneuverType === m.id ? 'bg-purple-600 text-white border-purple-600' : 'border-purple-200 hover:bg-purple-100'}`}
                                                    >
                                                        {m.n}
                                                    </button>
                                                ))}
                                            </div>
                                            <button 
                                                onClick={handleManeuver}
                                                className="w-full p-2 bg-purple-600 text-white font-bold text-sm hover:bg-purple-700"
                                            >
                                                ğŸ¤¼ æ‰§è¡Œæˆ˜æŠ€
                                            </button>
                                        </div>

                                        {/* å¥–åŠ±éª°è¯´æ˜å…¥å£ */}
                                        <button 
                                            onClick={() => setDicePopoverOpen(true)}
                                            className="w-full text-xs text-gray-400 hover:text-black underline"
                                        >
                                            [Â±] å¥–åŠ±éª°/æƒ©ç½šéª°è§„åˆ™è¯´æ˜
                                        </button>
                                    </>
                                )}
                                
                                <button onClick={nextTurn} className="w-full py-2 text-xs text-gray-400 hover:text-gray-600 border border-gray-200">
                                    è·³è¿‡å›åˆ
                                </button>
                            </div>
                        )}

                        {/* ç­‰å¾…é˜²å¾¡é€‰æ‹© */}
                        {phase === 'waiting_defense' && (
                            <div className="space-y-4">
                                <div className="flex justify-between items-center px-4 py-2 bg-gray-50 border">
                                    <div className="text-center">
                                        <div className="font-bold text-sm">{combatAction?.attacker.name}</div>
                                        <div className="text-[10px] bg-black text-white px-2 inline-block">æ”»</div>
                                    </div>
                                    <div className="font-black text-xl text-gray-300">VS</div>
                                    <div className="text-center">
                                        <div className="font-bold text-sm">{combatAction?.target.name}</div>
                                        <div className="text-[10px] bg-gray-400 text-white px-2 inline-block">é˜²</div>
                                    </div>
                                </div>
                                
                                {targetActor?.status.defenseUsedThisRound && (
                                    <div className="text-xs text-center text-yellow-800 bg-yellow-50 p-2 border border-yellow-200">
                                        âš ï¸ æœ¬è½®å·²é˜²å¾¡è¿‡ (æ”»å‡»æ–¹è·å¥–åŠ±éª°)
                                    </div>
                                )}
                                
                                <div className="grid grid-cols-2 gap-3">
                                    <button 
                                        onClick={() => {
                                            setCombatAction(p => ({
                                                ...p,
                                                defenseType: 'counter',
                                                defenderSkill: targetActor.fight
                                            }));
                                            setPhase('input_roll');
                                        }} 
                                        className="bg-red-50 border border-red-200 p-4 hover:bg-red-100"
                                    >
                                        <div className="font-bold text-red-900 text-sm">âš”ï¸ åå‡»</div>
                                        <div className="text-[10px] text-red-600">{targetActor?.fight}%</div>
                                    </button>
                                    <button 
                                        onClick={() => {
                                            setCombatAction(p => ({
                                                ...p,
                                                defenseType: 'dodge',
                                                defenderSkill: targetActor.dodge
                                            }));
                                            setPhase('input_roll');
                                        }} 
                                        className="bg-blue-50 border border-blue-200 p-4 hover:bg-blue-100"
                                    >
                                        <div className="font-bold text-blue-900 text-sm">ğŸ’¨ é—ªé¿</div>
                                        <div className="text-[10px] text-blue-600">{targetActor?.dodge}%</div>
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* è¾“å…¥æ£€å®šç»“æœ */}
                        {(['input_roll', 'input_defense_roll', 'input_damage'].includes(phase)) && combatAction && (
                            <div className="space-y-4">
                                <h3 className="text-sm font-bold text-center border-b pb-2">
                                    {phase === 'input_damage' ? 'ä¼¤å®³ç»“ç®—' : 
                                     phase === 'input_roll' ? `${currentActor.name} æ£€å®š` : 
                                     `${targetActor.name} é˜²å¾¡`}
                                </h3>
                                
                                {phase !== 'input_damage' && (
                                    <div className="text-center">
                                        <span className="text-xs text-gray-400 font-bold">ç›®æ ‡å€¼</span>
                                        <div className="text-3xl font-mono font-bold">
                                            {phase === 'input_roll' 
                                                ? (combatAction.type === 'ranged' ? currentActor.firearms : combatAction.attackerSkill) 
                                                : combatAction.defenderSkill}
                                        </div>
                                    </div>
                                )}
                                
                                {phase === 'input_damage' && (
                                    <div className="text-center font-mono text-sm bg-gray-50 p-2 border">
                                        {combatAction.weapon?.name} ({combatAction.weapon?.damage})
                                    </div>
                                )}
                                
                                <div className="flex gap-2">
                                    <input 
                                        type="number" 
                                        value={inputValue} 
                                        onChange={e => setInputValue(e.target.value)} 
                                        onKeyDown={e => e.key === 'Enter' && (
                                            phase === 'input_damage' ? handleDamage() : 
                                            phase === 'input_defense_roll' ? handleDefenseRoll() : 
                                            handleRoll()
                                        )} 
                                        className="w-full text-2xl font-mono border-2 px-2 py-2 text-center focus:border-black outline-none" 
                                        placeholder={phase === 'input_damage' ? "ä¼¤å®³å€¼" : "1-100"} 
                                        autoFocus 
                                    />
                                    <button 
                                        onClick={() => {
                                            if (phase === 'input_damage') {
                                                const dmg = calculateDamage(
                                                    combatAction.weapon, 
                                                    combatAction.damageAttacker, 
                                                    combatAction.damageSuccessLevel || 1, 
                                                    !!combatAction.isCounterAttack
                                                );
                                                setInputValue(String(dmg.total));
                                            } else {
                                                setInputValue(String(Math.floor(Math.random() * 100) + 1));
                                            }
                                        }} 
                                        className="px-4 bg-gray-100 font-bold border"
                                    >
                                        ğŸ²
                                    </button>
                                </div>
                                
                                <button 
                                    onClick={phase === 'input_damage' ? handleDamage : phase === 'input_defense_roll' ? handleDefenseRoll : handleRoll} 
                                    disabled={!inputValue} 
                                    className="w-full bg-black text-white py-3 font-bold text-sm disabled:opacity-50"
                                >
                                    ç¡®è®¤
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            </div>

            {/* å³ä¾§ï¼šæˆ˜æ–—æ—¥å¿— */}
            <div className={`panel-right ${mobileTab === 'log' ? 'panel-mobile-active' : ''}`}>
                <div className="p-3 border-b border-gray-200 text-[10px] font-bold text-gray-400 uppercase flex-shrink-0 bg-white">æˆ˜æ–—æ—¥å¿—</div>
                <div className="log-scroll-area" ref={logContainerRef}>
                    <div className="space-y-2">
                        {logs.map(log => (
                            <div key={log.id} className="flex flex-col items-start">
                                <div className="text-[9px] text-gray-300 mb-1 font-mono pl-1">{log.time}</div>
                                <div className={`log-item w-full ${log.type}`}>{log.text}</div>
                            </div>
                        ))}
                    </div>
                </div>
            </div>

            {/* ç§»åŠ¨ç«¯åº•éƒ¨å¯¼èˆª */}
            <div className="mobile-nav md:hidden lg:hidden fixed bottom-0 left-0 w-full h-14 bg-white border-t flex justify-around items-center z-50">
                <button onClick={() => setMobileTab('status')} className={`flex flex-col items-center justify-center w-full h-full transition-colors ${mobileTab === 'status' ? 'text-blue-600' : 'text-gray-400'}`}>
                    <span className="text-lg">ğŸ“Š</span>
                    <span className="text-[10px] font-bold">çŠ¶æ€</span>
                </button>
                <button onClick={() => setMobileTab('action')} className={`flex flex-col items-center justify-center w-full h-full transition-colors ${mobileTab === 'action' ? 'text-blue-600' : 'text-gray-400'}`}>
                    <span className="text-lg">âš”ï¸</span>
                    <span className="text-[10px] font-bold">è¡ŒåŠ¨</span>
                </button>
                <button onClick={() => setMobileTab('log')} className={`flex flex-col items-center justify-center w-full h-full transition-colors ${mobileTab === 'log' ? 'text-blue-600' : 'text-gray-400'}`}>
                    <span className="text-lg">ğŸ“œ</span>
                    <span className="text-[10px] font-bold">æ—¥å¿—</span>
                </button>
            </div>

            {/* å¥–åŠ±éª°è¯´æ˜å¼¹çª— */}
            <DiceModifierPopover isOpen={dicePopoverOpen} onClose={() => setDicePopoverOpen(false)} />
        </div>
    );
}

// =====================================================
// åŒ»ç–—æŠ½å±‰ç»„ä»¶
// =====================================================
function MedicalDrawer({ isOpen, onClose, characters, updateChar, addLog }) {
    const [targetId, setTargetId] = useState(''); 
    const [healerId, setHealerId] = useState('');
    
    const healer = characters.find(c => c.id === healerId);
    const target = characters.find(c => c.id === targetId);

    const performFirstAid = () => {
        if (!target || !healer) return;
        
        // æ€¥æ•‘æ£€å®š
        const roll = Math.floor(Math.random() * 100) + 1;
        const success = calculateSuccessLevel(roll, healer.firstAid || 30);
        
        addLog(`ğŸ©¹ ${healer.name} å¯¹ ${target.name} è¿›è¡Œæ€¥æ•‘æ£€å®š [${roll}] vs ${healer.firstAid || 30}`, 'roll');
        
        if (success > 0) {
            if (target.status.dying) {
                // ç¨³å®šæ¿’æ­»è€…
                updateChar(targetId, { 
                    hp: 1, 
                    status: { ...target.status, dying: false } 
                });
                addLog(`âœ… ${target.name} è„±ç¦»æ¿’æ­»çŠ¶æ€`, 'success');
            } else if (target.status.unconscious) {
                // å”¤é†’æ˜è¿·è€…
                updateChar(targetId, { status: { ...target.status, unconscious: false } });
                addLog(`âœ… ${target.name} æ¢å¤æ„è¯†`, 'success');
            } else {
                // æ¢å¤1HP
                const newHp = Math.min(target.maxHp, target.hp + 1);
                updateChar(targetId, { hp: newHp });
                addLog(`âœ… ${target.name} æ¢å¤ 1 HP`, 'success');
            }
        } else {
            addLog(`âŒ æ€¥æ•‘å¤±è´¥`, 'system');
        }
    };

    const performMedicine = () => {
        if (!target || !healer) return;
        
        // åŒ»å­¦æ£€å®š
        const roll = Math.floor(Math.random() * 100) + 1;
        const success = calculateSuccessLevel(roll, healer.medicine || 5);
        
        addLog(`âš•ï¸ ${healer.name} å¯¹ ${target.name} è¿›è¡ŒåŒ»å­¦æ£€å®š [${roll}] vs ${healer.medicine || 5}`, 'roll');
        
        if (success > 0) {
            const heal = rollDice('1D3');
            const newHp = Math.min(target.maxHp, target.hp + heal.total);
            updateChar(targetId, { hp: newHp });
            addLog(`âœ… ${target.name} æ¢å¤ ${heal.total} HP (1D3)`, 'success');
        } else {
            addLog(`âŒ åŒ»å­¦æ²»ç–—å¤±è´¥`, 'system');
        }
    };

    return (
        <>
            {isOpen && <div className="fixed inset-0 bg-black/20 z-40" onClick={onClose} />}
            <div className={`fixed inset-y-0 right-0 w-72 bg-white border-l-2 border-green-600 transform transition duration-300 z-50 flex flex-col ${isOpen ? 'translate-x-0' : 'translate-x-full'}`}>
                <div className="p-4 border-b flex justify-between items-center bg-green-600 text-white">
                    <h2 className="font-bold">ğŸ¥ åŒ»ç–—ç«™</h2>
                    <button onClick={onClose} className="text-2xl">&times;</button>
                </div>
                <div className="p-4 space-y-4 flex-1 overflow-y-auto">
                    <div>
                        <label className="text-xs font-bold text-gray-400">æ–½æ•‘è€…</label>
                        <select className="w-full border p-2 text-sm" value={healerId} onChange={e => setHealerId(e.target.value)}>
                            <option value="">--é€‰æ‹©--</option>
                            {characters.filter(c => c.hp > 0).map(c => (
                                <option key={c.id} value={c.id}>
                                    {c.name} (æ€¥æ•‘:{c.firstAid || 30} åŒ»å­¦:{c.medicine || 5})
                                </option>
                            ))}
                        </select>
                    </div>
                    <div>
                        <label className="text-xs font-bold text-gray-400">ä¼¤å‘˜</label>
                        <select className="w-full border p-2 text-sm" value={targetId} onChange={e => setTargetId(e.target.value)}>
                            <option value="">--é€‰æ‹©--</option>
                            {characters.map(c => (
                                <option key={c.id} value={c.id}>
                                    {c.name} (HP:{c.hp}/{c.maxHp}) {c.status.dying ? 'æ¿’æ­»' : ''} {c.status.unconscious ? 'æ˜è¿·' : ''}
                                </option>
                            ))}
                        </select>
                    </div>
                    <div className="grid grid-cols-1 gap-2 pt-4">
                        <button 
                            disabled={!targetId || !healerId} 
                            onClick={performFirstAid} 
                            className="border p-3 hover:bg-green-50 font-bold text-sm disabled:opacity-50"
                        >
                            ğŸ©¹ æ€¥æ•‘ (æ¢å¤1HP / ç¨³å®šæ¿’æ­» / å”¤é†’)
                        </button>
                        <button 
                            disabled={!targetId || !healerId} 
                            onClick={performMedicine} 
                            className="border p-3 hover:bg-blue-50 font-bold text-sm disabled:opacity-50"
                        >
                            âš•ï¸ åŒ»å­¦ (æ¢å¤1D3 HP, éœ€1å°æ—¶)
                        </button>
                    </div>
                    <div className="text-xs text-gray-400 mt-4 p-2 bg-gray-50 border">
                        <div className="font-bold mb-1">è§„åˆ™è¯´æ˜ï¼š</div>
                        <ul className="space-y-1">
                            <li>â€¢ æ€¥æ•‘ï¼šå—ä¼¤å1å°æ—¶å†…æœ‰æ•ˆï¼Œæ¯æ¬¡å—ä¼¤ä»…èƒ½æ€¥æ•‘1æ¬¡</li>
                            <li>â€¢ åŒ»å­¦ï¼šéœ€è¦è‡³å°‘1å°æ—¶ï¼Œæ¯æ¬¡å—ä¼¤ä»…èƒ½åŒ»å­¦æ²»ç–—1æ¬¡</li>
                            <li>â€¢ æ€¥æ•‘å¯ç¨³å®šæ¿’æ­»è€…æˆ–å”¤é†’æ˜è¿·è€…</li>
                        </ul>
                    </div>
                </div>
            </div>
        </>
    );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
